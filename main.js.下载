$(document).ready(function(){
	
	//Notice
	noticeInit();
	
	//Zurb tables
	tableInit();
	
	//Setup bulk
	initialize();
	
	//Enable selectmenu
	if ($('#content select.sorter, .content-section select.sorter, .monkForm select').length > 0) {
		selectors();
	}
	
	//Billboard
	if($('#billboard.hasvideo').length>0){
		bigVideo();
	}else if($('#billboard.hasrotator').length>0){
		rotator();
		videoSlide();
	}	
	
});

/*============================================
 * Initialize
 *=============================================
*/
function initialize(){
	
	// Site defaults
	global();
	
	//Monklets
	monklets();
	
	// Normalize behavior on mobile devices
	mobileFix();
	
	// Avoid console errors in browsers that lack a console.
	consoleFix();
	
}

/*============================================
 * Selectmenu
 *=============================================
*/
function selectors(){
	var changeSelectMenu = function(event, item) {
		$(this).trigger('change', item);
	};
	selectmenu();
	enquire.register("screen and (max-width: 64.25em)", {//match css container breakpoint
		setup : function() {
			 selectmenu();
		},
		match : function() {
			$('#content select.sorter, .content-section select.sorter, .monkForm select').selectmenu('destroy');
		},
		unmatch : function() {
			 selectmenu();
		}  
	});
	function selectmenu(){
		var menuwidth = 190;
		if($('#sidebar .filters').length){
			var menuwidth = 320;
		}
		$('#content select.sorter, .content-section select.sorter, .monkForm select').selectmenu({
			width: menuwidth,
			style:'dropdown',
			change: changeSelectMenu
		});
		$('.ui-selectmenu-button').append("<span class='icon-chevron-down'></span>");
	}
}


/*============================================
 * Global Stuff
 *=============================================
*/
 function global(){
	
	//define touch
	if(mobileDetect()||touchDetect()){
		$('html').addClass('touch-on');
	}else{
		$('html').addClass('touch-off');
	}
	
	//set no links
	$('a[href*="#"]').addClass('nolink');
	$('a[href=""]').addClass('nolink');
	
	//responsive third party vids
	$('#content, .content-section, #billboard .text').fitVids({
		ignore: '#video-player, .div-embed',
		customSelector: "iframe[src*='/Clients/player/videoembed.php']"
	});
	
	//scrolls
	if($('#welcome-scroll').length){
		if($('#welcome-scroll').length){
			$('#welcome-scroll').attr('href','#welcome-links').addClass('scrollto');
		}else{
			var firstSecID = $('.content-section').first().attr('id');
			$('#welcome-scroll').attr('href','#'+firstSecID).addClass('scrollto');
		}
	}
	$('.scrollto').click( function() {
		var pageLoc = $(this).attr('href');
		if($('#welcome-links').length){
			$('html, body').animate( { scrollTop: $(pageLoc).offset().top-120 }, 550 );
		}else{
			$('html, body').animate( { scrollTop: $(pageLoc).offset().top }, 550 );
		}
		return false;
	});
	$('#scrolltop').click(function(event){
		event.preventDefault();
		$('html, body').animate({scrollTop:0}, 'slow');
	});
			
	//colorbox defaults
	$('.thickbox').colorbox({ iframe: true, opacity: 0.85, width: 860,height: 650,maxWidth: "75%",maxHeight: "75%" }); 
	$('.slideshow').colorbox({slideshow: true,photo: true,preloading: true,slideshowSpeed: 5000,slideshowAuto: false, maxWidth: "75%",maxHeight: "75%"});
	
	//sticky header
	var stickyHeader = new Waypoint.Sticky({
	  element: $('#header')[0],
	  offset: -1,
	  handler: function(dir) {
		if (dir === 'down') {
		}
		else {	
    	}
	  }
	});
	
	//search
	$('#header .search').on('click', function(event) {
		event.preventDefault();
		$(this).toggleClass('active');
		$('#searchForm').toggleClass('active');
	});
	
	//desktop nav
	var hoverConfig = {
		interval: 150,
		over: addHover,
		timeout: 250,
		out: removeHover
	};
	function addHover() {
		$(this).addClass('active');
	}
	function removeHover() {
		$(this).removeClass('active');
	}
	$('#nav>li').hoverIntent(hoverConfig);
	
	//mobile nav
	$('#mobile-toggle').on('click', function(event) {
		event.preventDefault();
		$('body').toggleClass('show-mobile');
	});
	$('#mobilenav li a').each(function(){
		if($(this).parent().children("ul").length){
			$(this).parent().addClass('dropdown');
			var mnhref = $(this).attr('href');
			$(this).append('<span><i></i></span>');
			if(mnhref==''||mnhref=='#'){
				$(this).addClass('open');
			}else{
				$(this).find('i').addClass('open');
			}
		}
	});
	$('#mobilenav li.dropdown .open').on('click', function(event){
		$(this).closest('li').toggleClass('active');
		event.preventDefault();
	});
	
	//stellar for parallax bg's
	if(!mobileDetect()||!touchDetect()){
		$.stellar({
			horizontalScrolling: false,
			verticalScrolling: true,
			horizontalOffset: 0,
			verticalOffset: 0,
			responsive: false,
			scrollProperty: 'scroll',
			positionProperty: 'transform',
			parallaxBackgrounds: true,
			parallaxElements: false,
			hideDistantElements: false
		});
	}
		
	//window resize
	var resizeTimer = null;
	$(window).on('resize', function() {
		if (resizeTimer) clearTimeout(resizeTimer);
		resizeTimer = setTimeout(siteReset, 150);
	});
	function siteReset() {
		$('#cboxClose').click();
	}
		
 }
	
/*============================================
 * Monklets
 *=============================================
*/
 function monklets(){
	
	//sermon icons
	$('.widget .player.watch a').html("").append('<span class="icon-screen"></span>');
	$('.widget .player.listen a').html("").append('<span class="icon-volume-high"></span>');

	//section events
	$('.widget.section-events').each(function(){
		$(this).parents('.content-section').addClass('two-cols');
		$(this).parents('.content-section-inner').prepend('<div class="left-col"><h4><span><i class="icon-calendar-full"></i> Coming Events</h4></span></div>');
	});
	
	//section stories
	$('.widget.section-articles').each(function(){
		var $storyContainer = $(this).find('.more-articles');
		var storyCat = $storyContainer.data('category');
		if($storyContainer){
			$storyContainer.addClass('loading');
			$.ajax({
				url : '/_components/ajax/ajax-more-articles.php',
				type: "GET",
				data: ({'category':storyCat}),
				success:function(results) {
					$storyContainer.removeClass('loading').html(results);
					videoSlide();
				},
				error: function(data, textStatus, jqXHR) {
					//add error messages as needed console.log(jqXHR.responseText);
				}
			});
		}
	});
	
	//home page animation
	/*
	if($('body').hasClass('homepage')){
		$('.content-section .widget').each(function(){
			var secID = $(this).parents('.content-section').attr('id');
			var waypointsecID = 'waypoint'+secID;
			var waypointsecID = new Waypoint.Inview({
			  element: document.getElementById(secID),
			  enter: function(dir) {
				  $('#'+secID).addClass('animate');
			  },
			  exited: function(dir) {
				  //$('#'+secID).removeClass('animate');
			  }
			});
		});
	}
	*/			
 }


/*============================================
 * Rotator
 *=============================================
*/
function rotator(){
	
	$('.rotator .cycle-ss').each(function(){
		var $slideshow = $(this);
		var slidecount = $slideshow.find('.slide').length;
		$slideshow.on({
			'cycle-initialized': function(){
				$('body').addClass('js-rotator');
			}
		});
		$slideshow.cycle();// Auto initialization
	});
			
}

/*============================================
 * Video Slide
 *=============================================
*/
function videoSlide(){

	// Video Slide 
	$('.video-slide').click(function(event){
		event.preventDefault();	
		var $this = $(this),
			width = 800,
			height = 448,
			title = $this.data('title');

		// If the video is embedded
		if($this.data('video-type')=='embed')
		{
			var video = true;
				url = $this.data('embed-src'),
				mediaURL = updateURLParam(url,'autoplay',0);
		} 
		// If the video is uploaded file
		else if($this.data('video-type')=='file') 
		{
			var video = true,
				mediaURL = $this.data('file-url'),
				mediaImg = encodeURIComponent($this.data('image')),
				mediaExt = mediaURL.substr((mediaURL.lastIndexOf('.')+1)).toLowerCase(),
				JWformats = new Array('mp3', 'aac', 'm4a', 'f4a', 'flv', 'mp4', 'm4v', 'f4v', 'mov');
			// JW Compatable
			if($.inArray(mediaExt, JWformats)>-1)
			{
				var url =
					'/_components/popup/popup.php'
					+'?file='+mediaURL
					+'&title='+title
					+'&mediaWidth='+width
					+'&mediaHeight='+height
					+'&image='+mediaImg;	
			}
		}
		// Is a video
		if(video)
		{

			//console.log('video:'+video);
			//console.log('mobile:'+mobileDetect());
			// If mobile
			if(mobileDetect())
			{
				window.open(mediaURL);
			} 
			else 
			{
				//console.log('url:'+url);
				$.colorbox({
					iframe: true,
					href: url,
					innerWidth: width,
					innerHeight: height,
					maxWidth: "75%", 
					maxHeight: "60%",
					title: title,
					onOpen: function(){
						$('#cycle-ss').cycle('pause');
					},
					onCleanup: function(){
						$('#cycle-ss').cycle('resume');
					}
				});
			}
		}	
	});
}

/*============================================
 * Big Video
 *=============================================
*/
function bigVideo() {
	var resize = function() {
	billboardReset();
	if (!shouldResize) { return; }

	var height = $parent.height();
	var width = $parent.width();
	var viewportRatio = width / height;
	var scale = 1;

	if (videoRatio < viewportRatio) {
		// viewport more widescreen than video aspect ratio
		scale = viewportRatio / videoRatio;
	} else if (viewportRatio < videoRatio) {
		// viewport more square than video aspect ratio
		scale = videoRatio / viewportRatio;
	}
	var offset = positionVideo(scale, width, height);
		setVideoTransform(scale, offset);
	};

	var setVideoTransform = function(scale, offset) {
		offset = $.extend({ x: 0, y: 0 }, offset);
		var transform = 'translate(' + Math.round(offset.x) + 'px,' + Math.round(offset.y) + 'px) scale(' + scale  + ')';
		$player.css({
			'-webkit-transform': transform,
			'transform': transform
		});
	};
	// accounts for transform origins on scaled video
	var positionVideo = function(scale, width, height) {
		if (!shouldPosition) { return false; }
			var x = parseInt($player.data('origin-x'), 10);
		var y = parseInt($player.data('origin-y'), 10);
		setVideoOrigin(x, y);
			var viewportRatio = width / height;
		var scaledHeight = scale * height;
		var scaledWidth = scale * width;
		var percentFromX = (x - 50) / 100;
		var percentFromY = (y - 50) / 100;
		var offset = {};
			if (videoRatio < viewportRatio) {
			offset.x = (scaledWidth - width) * percentFromX;
		} else if (viewportRatio < videoRatio) {
			offset.y = (scaledHeight - height) * percentFromY;
		}
			return offset;
	};
		var setVideoOrigin = function(x, y) {
		var origin = x + '% ' + y + '%';
		$player.css({
			'-webkit-transform-origin': origin,
			'transform-origin': origin
		});
	};
	//check of mobile and vidoe support by default/fallback billboard will show bg image
	if(!mobileDetect() && Modernizr.video){
		//check for billboard video
		var videofile = $('#billboard').data('big-video'),
			videofileExt = videofile.substr((videofile.lastIndexOf('.')+1)).toLowerCase();
			videoHTML = '<div id="bigvideo"><video id="billboardvideo" autoplay loop muted><source src="'+videofile+'"></video></div>';
		//if video file and mp4 then
		if(videofile&&videofileExt=='mp4'){
			$('#billboard').prepend(videoHTML);
			var $player = $('#bigvideo video');
			var player = $player.get(0);
			var $parent = $player.parent();
			var $win = $(window);
			var resizeTimeout = null;
			var shouldResize = true;
			var shouldPosition = false;
			//var videoRatio = 16 / 9;
			var videoRatio = 16 / 9;
			player.volume = 0; // mute
			
			//initial resize
			resize();
			$parent.delay(350).fadeIn();
			
			//window resize
			$win.on('resize', function() {
				clearTimeout(resizeTimeout);
				resizeTimeout = setTimeout(resize, 100);
			});
		}
	}
	/*function billboardReset() {
		if($(window).width() > 1028){
			var windowHeight = $(window).height(),
				headerHeight = $('#header').height(),
				billDif = windowHeight-headerHeight;
			$('#billboard').css('height',billDif+'px');
		}else{
			$('#billboard').css('height','auto');
		}
	}*/	
	function billboardReset() {
		if (parseInt($('#billboard').css('width')) >= 1024) {
		var 	billWidth = $('#billboard').width(),
		billRatio = billWidth/1.77777777777778;
		$('#billboard').css('height',billRatio+'px');
				//billRatio = 16/9
		}else{
			$('#billboard').css('height','auto');
		}
	}
}


/*============================================
 * Mobile Fix
 *=============================================
*/
 function mobileFix(){

	// If its mobile and there isn't a hash...
	if(mobileDetect() && !window.location.hash){
		// Set a timeout...
		setTimeout(function(){
			// Hide the address bar!
			window.scrollTo(0, 1);
		}, 0);
	}
 }


/*============================================
 * Console Fix
 *=============================================
*/
function consoleFix(){
	
	var method;
	var noop = function noop() {};
	var methods = [
		'assert', 'clear', 'count', 'debug', 'dir', 'dirxml', 'error',
		'exception', 'group', 'groupCollapsed', 'groupEnd', 'info', 'log',
		'markTimeline', 'profile', 'profileEnd', 'table', 'time', 'timeEnd',
		'timeStamp', 'trace', 'warn'
	];
	var length = methods.length;
	var console = (window.console = window.console || {});

	while (length--) {
		method = methods[length];

		// Only stub undefined methods.
		if (!console[method]) {
			console[method] = noop;
		}
	}
}
	
/*============================================
 * Mobile Detect
 *=============================================
*/
function mobileDetect() {

	var check = false;
	(function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))check = true})(navigator.userAgent||navigator.vendor||window.opera);
	return check; 
}

/*============================================
 * Touch Detect
 *=============================================
*/
function touchDetect() {
  return (('ontouchstart' in window)
	|| (navigator.MaxTouchPoints > 0)
	|| (navigator.msMaxTouchPoints > 0));
}


/*============================================
 * Get URL Param
 *=============================================
*/
function getURLParam(url, param) {
	param = param.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
	var regexS = "[\\?&]" + param + "=([^&#]*)";
	var regex = new RegExp(regexS);
	var results = regex.exec(url);
	if(results == null) {
	    return "";
	} else {
	    return decodeURIComponent(results[1].replace(/\+/g, " "));
	}
}

/*============================================
 * Update URL Param
 *=============================================
*/
function updateURLParam(url, param, val) {
	var re = new RegExp("([?|&])" + param + "=.*?(&|$)", "i"),separator = url.indexOf('?') !== -1 ? "&" : "?";
	if (url.match(re)) {
		var url_new = url.replace(re, '$1' + param + "=" + val + '$2');
	} else {
		var url_new = url + separator + param + "=" + val;
	}
	return url_new;
}
		
/*============================================
 * Parse Param
 *=============================================
*/
function parseParams(url) {
	 var params=url;
	 if (url.match(/\?(.+)$/)) {
	   // in case it is a full query string with ?, only take everything after the ?
	   params = RegExp.$1;
	 }
	// split the params
	var pArray = params.split("&");
	// hash to store result
	var pHash = {};
	// parse each param in the array and put it in the hash
	for (var i=0;i<pArray.length;i++) {
		var temp = pArray[i].split("=");
		pHash[temp[0]] = decodeURIComponent(temp[1]); //decode to account for characters.
	}
	return pHash;
}

/*============================================
 * Update Param in Src
 *=============================================
*/
function updateParamInSrc(html, key, value) {
	var html_array = html.split(' ');
	for (var i=0; i<html_array.length; i++) {
		if (html_array[i].match("src=")){
			var src_index = i;
			var src_string = html_array[i];
		}
	}
	var src = src_string.replace(/^.*src="(.*)".*$/m, '$1');
	var re = new RegExp("([?|&])" + key + "=.*?(&|$)", "i"), separator = src.indexOf('?') !== -1 ? "&" : "?";
	if (src.match(re)){
		var src_new = src.replace(re, '$1' + key + "=" + value + '$2');
	} else {
		var src_new = src + separator + key + "=" + value;
	}
	src_string_new = 'src="' + src_new + '"';
	html_array[src_index] = src_string_new;
	return html_array.join(' ');
}
